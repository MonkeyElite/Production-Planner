name: Secure CI/CD Demo

on:
    push:
        branches: ["main"]
    pull_request:

permissions:
    contents: read
    packages: write
    id-token: write
    security-events: write

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}
    IMAGE_TAG: ${{ github.sha }}

jobs:
    security_checks:
        name: Static & Dependency Security Checks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            # ---- build/test ----
            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "8.0.x"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: apps/web/package-lock.json

            - name: Install dependencies
              working-directory: apps/web
              run: npm ci

            - name: Run frontend lint
              working-directory: apps/web
              run: npm run lint --if-present

            - name: Audit frontend dependencies
              working-directory: apps/web
              run: npm audit --audit-level=high --production=false

            - name: Run unit tests
              working-directory: apps/web
              run: npm test --if-present

            - name: Restore .NET dependencies
              run: dotnet restore apps/svc.products.Tests/svc.products.Tests.csproj

            - name: Run backend security tests
              run: dotnet test apps/svc.products.Tests/svc.products.Tests.csproj --configuration Release

            - name: Check vulnerable .NET packages
              run: dotnet list apps/svc.products/svc.products.csproj package --vulnerable --include-transitive

            - name: Run .NET code analysis
              run: dotnet format --verify-no-changes apps/svc.products/svc.products.csproj

            # ---- Secret scanning with Gitleaks ----
            - name: Secret scan
              uses: zricethezav/gitleaks-action@v2
              with:
                  config-path: ""
                  fail: "true"

            # ---- SAST with Semgrep ----
            - name: Static analysis
              uses: returntocorp/semgrep-action@v1
              with:
                  config: "p/ci"
              env:
                  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN || '' }}

            # ---- Dependency scanning ----
            # - name: Dependency scan
            #   run: |
            #       mkdir -p dependency-check
            #       docker run --rm \
            #         -v "$(pwd)":/src \
            #         -v "$(pwd)/dependency-check":/report \
            #         owasp/dependency-check:latest \
            #         --scan /src \
            #         --format "HTML" \
            #         --out /report

            - name: Upload dependency-check report
              uses: actions/upload-artifact@v4
              with:
                  name: dependency-check-report
                  path: dependency-check

            # ---- Filesystem vulnerability scan ----
            - name: Filesystem scan
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  ignore-unfixed: true
                  vuln-type: "os,library"
                  format: "table"
                  exit-code: "1"

            # ---- IaC scanning ----
            - name: IaC security scan with Checkov
              uses: bridgecrewio/checkov-action@v12
              with:
                  directory: .
                  quiet: true
                  soft_fail: true

    build_and_scan_image:
        name: Build, Scan & Publish Docker Image
        runs-on: ubuntu-latest
        needs: security_checks

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Docker image
              run: |
                  IMAGE_NAME_LOWER="${IMAGE_NAME,,}"   # force lowercase
                  IMAGE="${REGISTRY}/${IMAGE_NAME_LOWER}:${IMAGE_TAG}"
                  echo "IMAGE=$IMAGE" >> $GITHUB_ENV

                  docker build -t "$IMAGE" -f apps/web/Dockerfile apps/web

            # Image-level vulnerability scan
            - name: Trivy image scan
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "image"
                  image-ref: ${{ env.IMAGE }}
                  ignore-unfixed: true
                  vuln-type: "os,library"
                  format: "table"
                  exit-code: "1"

            - name: Push Docker image to GHCR
              run: |
                  docker push "$IMAGE"

    sign_image:
        name: Sign Image
        runs-on: ubuntu-latest
        needs: build_and_scan_image

        steps:
            - name: Install Cosign
              uses: sigstore/cosign-installer@v3.5.0
              with:
                  cosign-release: "v2.4.0"

            - name: Sign image with Cosign keyless
              env:
                  COSIGN_EXPERIMENTAL: "1"
              run: |
                  IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
                  echo "Signing $IMAGE"
                  # Keyless signing uses GitHub OIDC identity
                  cosign sign "$IMAGE"

    deploy_to_kind:
        name: Deploy to Kind
        runs-on: ubuntu-latest
        needs: sign_image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Install kubectl
              run: |
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  sudo mv kubectl /usr/local/bin/

            - name: Install Kind
              run: |
                  curl -Lo kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
                  chmod +x kind
                  sudo mv kind /usr/local/bin/kind

            - name: Create Kind cluster
              run: |
                  kind create cluster --name secure-demo --wait 60s
                  kubectl cluster-info

            - name: Load image from GHCR
              run: |
                  IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
                  echo "Pulling image $IMAGE from GHCR"
                  docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
                  docker pull "$IMAGE"
                  kind load docker-image "$IMAGE" --name secure-demo

            - name: Apply Production Planner manifests
              run: |
                  kubectl apply -f k8s/namespace.yaml
                  kubectl apply -f k8s/

            - name: Update deployment image and wait for rollout
              run: |
                  IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
                  echo "Setting image on deployment to $IMAGE"
                  kubectl set image \
                    deployment/production-planner-web \
                    production-planner-web="$IMAGE" \
                    -n production-planner
                  kubectl rollout status deployment/production-planner-web -n production-planner --timeout=180s

            - name: Show running resources
              run: |
                  kubectl get pods -n production-planner
                  kubectl get svc -n production-planner
